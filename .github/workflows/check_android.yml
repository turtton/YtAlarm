name: Run AndroidTest

on:
  issue_comment:
    types:
      - created

jobs:
  react:
    if: (github.event.issue.pull_request) && startsWith(github.event.comment.body, '/androidTest') && (github.repository_owner == 'turtton')
    runs-on: ubuntu-latest
    steps:
      - name: React comment
        uses: actions/github-script@v6
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { TOKEN } = process.env
            const client = new GitHub(TOKEN)
            client.reactions.createForIssueComment({
              context.repo.owner,
              context.repo.repo,
              comment_id: context.payload.comment.id,
              content: rocket
            })

  android_test:
    needs: react
    strategy:
      matrix:
        sdk-version: [24, 33]
    runs-on: macos-10.15
    steps:
      - name: Get upstream branch
        uses: actions/github-script@v6
        id: upstreambranch
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          result-encoding: string
          script: |
            const pull_request = await github.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            })
            return pull_request.data.head.ref

      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          ref: ${{ steps.upstreambranch.outputs.result }}

      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: gradle

      - name: Install Android SDK
        uses: malinskiy/action-android/install-sdk@release/0.1.3

      - name: Check android test
        uses: malinskiy/action-android/emulator-run-cmd@release/0.1.3
        with:
          cmd: ./gradlew connectedCheck --stacktrace
          api: ${{ matrix.sdk-version }}
          tag: default
          abi: x86

      - name: Save logcat output
        uses: actions/upload-artifact@master
        if: failure()
        with:
          name: logcat
          path: artifacts/logcat.log


  result:
    runs-on: ubuntu-latest
    needs: android_test
    if: always()
    steps:
      - name: Send result message
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const result = context.jobs.check.result
            github.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: "AndroidTest was ${result}. See [log](https://github.com/${context.github.repository}/actions/runs/${context.github.run_id})"
            })


